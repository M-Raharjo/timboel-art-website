{{ define "main" }}

  {{/* Prefer a bundled cover.* if present; else use params.featured_image */}}
  {{ $cover := .Resources.GetMatch "cover.*" }}

  <section class="bento-grid">
    <div class="bento-item item-xwide text-card">
      <h1>{{ .Title }}</h1>

      {{/* Use .Summary if set; else a trimmed plain version */}}
      <p>{{ with .Params.description }}{{ . }}{{ end }}</p>

      <ul>
        {{ with .Params.material }}<li><strong>Material:</strong> {{ . }}</li>{{ end }}
        {{ with .Params.size }}<li><strong>Size:</strong> {{ . }}</li>{{ end }}
        {{ with .Params.finishing }}<li><strong>Finishing:</strong> {{ . }}</li>{{ end }}
        {{ with .Params.collection }}<li><strong>Collection:</strong> {{ delimit . ", " }}</li>{{ end }}
        {{ with .Params.tag }}<li><strong>Tags:</strong> {{ delimit . ", " }}</li>{{ end }}
        {{ with .Params.item_id }}<li><strong>Item ID:</strong> {{ . }}</li>{{ end }}
      </ul>
    </div>

    <div class="bento-item item-wide">
      {{ if $cover }}
        <img src="{{ $cover.RelPermalink }}" alt="{{ .Title }}">
      {{ else if .Params.featured_image }}
        <img src="{{ .Params.featured_image | safeURL }}" alt="{{ .Title }}">
      {{ end }}
    </div>
  </section>

  {{/* Main body (adapter sets description as markdown in .Content) */}}
  {{ if .Content }}
    <section class="container" style="padding: 1rem 2rem;">
      {{ .Content }}
    </section>
  {{ end }}

  {{/* Product Gallery (params.gallery only) */}}
  <section class="gallery">
    <div class="item-gallery container">
      <h1>Product Gallery</h1>
      <p>A visual showcase</p>
    </div>
    <section class="bento-grid">
      {{ range .Params.gallery }}
          <figure class="bento-item">
            <img
              src="{{ . | safeURL }}"
              alt="{{ $.Title }}"
              loading="lazy"
              decoding="async"
            >
          </figure>
      {{ end }}
    </section>
  </section>


  {{/* CTA bento */}}
  <section class="bento-grid">
    <div class="bento-item item-xwide text-card">
      <h1>Let This Piece Elevate Your Space.</h1>
      <p>Love what you see? Contact us for pricing and customization.</p>
      <a href="/contact/" class="red-button">Contact Us</a>
    </div>
  
    {{ if $cover }}
      <div class="bento-item">
        <img src="{{ $cover.RelPermalink }}" alt="{{ $.Title }}">
      </div>
    {{ else if .Params.featured_image }}
      <div class="bento-item">
        <img src="{{ .Params.featured_image | safeURL }}" alt="{{ $.Title }}">
      </div>
    {{ end }}
  </section>

  {{/* Related Items (match by tags first, then collection, else any siblings) */}}
  <section>
    <h1 style="padding: 0 2rem;">Related Items</h1>
    {{ $siblings := .CurrentSection.RegularPages }}
    {{ $byTag := where $siblings "Params.tag" "intersect" .Params.tag }}
    {{ $byCollection := where $siblings "Params.collection" "intersect" .Params.collection }}
    {{ $related := cond (gt (len $byTag) 0) $byTag (cond (gt (len $byCollection) 0) $byCollection $siblings) }}
    {{ $related = where $related "RelPermalink" "ne" .RelPermalink }}

    <section class="bento-grid bento-description">
      {{ range first 5 $related }}
        <a class="bento-item" href="{{ .RelPermalink }}">
          {{ $rc := .Resources.GetMatch "cover.*" }}
          {{ if $rc }}
            <img src="{{ $rc.RelPermalink }}" alt="{{ .Title }}">
          {{ else if .Params.featured_image }}
            <img src="{{ .Params.featured_image | safeURL }}" alt="{{ .Title }}">
          {{ else }}
            <img src="https://placehold.co/300x200?text={{ urlquery .Title }}" alt="{{ .Title }}">
          {{ end }}
          <div>
            <h3>{{ .Title }}</h3>
            <p>{{ with .Summary }}{{ . }}{{ else }}{{ .Plain | truncate 100 }}{{ end }}</p>
          </div>
        </a>
      {{ end }}
    </section>
  </section>

{{ end }}
